<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="aFightz">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="aFightz">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="aFightz">






  <link rel="canonical" href="http://yoursite.com/page/8/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>aFightz</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">aFightz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/04/Spring Cloud与Docker微服务架构实战_03_开始使用Spring Cloud实战微服务--Spring Cloud/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/04/Spring Cloud与Docker微服务架构实战_03_开始使用Spring Cloud实战微服务--Spring Cloud/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">03 | 开始使用Spring Cloud实战微服务</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-04 10:57:39" itemprop="dateCreated datePublished" datetime="2019-06-04T10:57:39+08:00">2019-06-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/Spring-Cloud与Docker微服务架构实战/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud与Docker微服务架构实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="✎Maven项目转Gradle项目"><a href="#✎Maven项目转Gradle项目" class="headerlink" title="✎Maven项目转Gradle项目"></a><center><font color="#36648B">✎</font><br><font color="#36648B">Maven项目转Gradle项目</font></center></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle init --type pom</span><br></pre></td></tr></table></figure>
<h4 id="✎✎注解"><a href="#✎✎注解" class="headerlink" title="✎✎注解"></a><center><font color="#36648B">✎✎</font><br><font color="#36648B">注解</font></center></h4><ul>
<li><code>@GetMapping</code>相当于<code>@RequestMapping(method = RequestMethod.GET)</code>。类似的还有<code>@PutMapping</code>、<code>@DeleteMapping</code>等。</li>
<li><code>@SpringBootApplication</code>整合了<ul>
<li><code>@Configuration</code></li>
<li><code>@EnableAutoConfiguration</code></li>
<li><code>@ComponentScan</code></li>
</ul>
</li>
</ul>
<h4 id="✎✎✎YML"><a href="#✎✎✎YML" class="headerlink" title="✎✎✎YML"></a><center><font color="#36648B">✎✎✎</font><br><font color="#36648B">YML</font></center></h4><p>yml有严格的缩进、冒号后的空格不能少。</p>
<h4 id="✎✎✎✎Actuator"><a href="#✎✎✎✎Actuator" class="headerlink" title="✎✎✎✎Actuator"></a><center><font color="#36648B">✎✎✎✎</font><br><font color="#36648B">Actuator</font></center></h4><p>要让端点显示详情，可以用以下三种方式之一实现：</p>
<ul>
<li>添加<code>spring-boot-starter-security</code>这个starter pom。</li>
<li>设置<code>management.security.enabled=false</code>。</li>
<li>设置<code>management.endpoint.health.show-details=always</code>。</li>
</ul>
<p>可以用<code>info.*</code>属性定义info端点公开的数据。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/04/Spring Cloud与Docker微服务架构实战_02_微服务开发框架--Spring Cloud/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/04/Spring Cloud与Docker微服务架构实战_02_微服务开发框架--Spring Cloud/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">02 | 微服务开发框架--Spring Cloud</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-04 10:52:29" itemprop="dateCreated datePublished" datetime="2019-06-04T10:52:29+08:00">2019-06-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/Spring-Cloud与Docker微服务架构实战/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud与Docker微服务架构实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="✎Spring-Cloud版本介绍"><a href="#✎Spring-Cloud版本介绍" class="headerlink" title="✎Spring Cloud版本介绍"></a><center><font color="#36648B">✎</font><br><font color="#36648B">Spring Cloud版本介绍</font></center></h4><p>M表示里程碑版本。<br>SR表示“Service Base”。一般表示bug修复。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/04/Spring Cloud与Docker微服务架构实战_01_微服务架构概述/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/04/Spring Cloud与Docker微服务架构实战_01_微服务架构概述/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">01 | 微服务架构概述</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-04 10:45:53" itemprop="dateCreated datePublished" datetime="2019-06-04T10:45:53+08:00">2019-06-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/Spring-Cloud与Docker微服务架构实战/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud与Docker微服务架构实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2019/06/04/Spring Cloud与Docker微服务架构实战_01_微服务架构概述/微服务架构.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/05/SpringCloud微服务实战_03_服务治理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/05/SpringCloud微服务实战_03_服务治理/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">03 | 服务治理 ：Spring Cloud Eureka</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-05 10:43:35" itemprop="dateCreated datePublished" datetime="2019-05-05T10:43:35+08:00">2019-05-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/SpringCloud微服务实战/" itemprop="url" rel="index"><span itemprop="name">SpringCloud微服务实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring Cloud Eureka是Spring Cloud Netfix的一部分，基于Netfix Eureka做了二次封装。</p>
<h4 id="✎服务治理"><a href="#✎服务治理" class="headerlink" title="✎服务治理"></a><center><font color="#36648B">✎</font><br><font color="#36648B">服务治理</font></center></h4><p>服务治理包含了两部分的内容：<font color="#CD5555">服务注册</font>与<font color="#CD5555">服务发现</font>。<br><strong>1、什么叫做服务注册？</strong><br>服务注册就是服务单元向注册中心注册自己的服务。其中注册中心维护一个服务清单（一个服务可能有多个实例），还需要以心跳的方式去监测清单中的服务是否可用。</p>
<p><strong>2、什么叫做服务发现？</strong><br>服务调用方不会直接调用服务提供方，而是向注册中心请求这个服务的实例列表，之后通过某种策略从这列表中选出一个实例进行调用。</p>
<h4 id="✎✎Eureka服务器端-服务注册中心"><a href="#✎✎Eureka服务器端-服务注册中心" class="headerlink" title="✎✎Eureka服务器端(服务注册中心)"></a><center><font color="#36648B">✎✎</font><br><font color="#36648B">Eureka服务器端(服务注册中心)</font></center></h4><p>Eureka服务器端可以以集群方式部署，并且服务注册中心之间<font color="#CD5555">以异步模式互相复制各自的状态</font>。当某个分片（注册中心）故障时，继续提供服务的发现和注册。当故障分片恢复运行时，集群中的其他分片会把他们的状态同步回故障分片。</p>
<h4 id="✎✎✎搭建服务注册中心"><a href="#✎✎✎搭建服务注册中心" class="headerlink" title="✎✎✎搭建服务注册中心"></a><center><font color="#36648B">✎✎✎</font><br><font color="#36648B">搭建服务注册中心</font></center></h4><p><strong>1、maven配置</strong><br>在第二章maven配置的基础上，加上如下配置：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line"><span class="code">    &lt;dependency&gt;</span></span><br><span class="line"><span class="code">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">    &lt;/dependency&gt;</span></span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line"><span class="code">    &lt;dependencies&gt;</span></span><br><span class="line"><span class="code">        &lt;dependency&gt;</span></span><br><span class="line"><span class="code">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">            &lt;version&gt;Greenwich.RELEASE&lt;/version&gt;</span></span><br><span class="line"><span class="code">            &lt;type&gt;pom&lt;/type&gt;</span></span><br><span class="line"><span class="code">            &lt;scope&gt;import&lt;/scope&gt;</span></span><br><span class="line"><span class="code">        &lt;/dependency&gt;</span></span><br><span class="line"><span class="code">    &lt;/dependencies&gt;</span></span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>
<p><strong>2、注解</strong><br>在Application上加上<code>@EnableEurekaServer</code></p>
<p><strong>3、配置</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#服务器端口，默认为8761</span></span><br><span class="line">server.port=1111</span><br><span class="line"><span class="section">#是否向注册中心注册自己，默认为true</span></span><br><span class="line">eureka.client.register-with-eureka = false</span><br><span class="line"><span class="section">#是否去检索服务（服务发现），默认为true</span></span><br><span class="line">eureka.client.fetch-registry = false</span><br><span class="line"><span class="section">#默认为http://localhost:8761/eureka/</span></span><br><span class="line">eureka.client.serviceUrl.defaultZone = http://127.0.0.1:1111/eureka/</span><br><span class="line"><span class="section">#应用名</span></span><br><span class="line">spring.application.name=center1</span><br></pre></td></tr></table></figure>
<p><strong>4、访问注册中心页面</strong><br><code>http://127.0.0.1:1111/</code></p>
<h4 id="✎✎✎✎搭建服务提供者"><a href="#✎✎✎✎搭建服务提供者" class="headerlink" title="✎✎✎✎搭建服务提供者"></a><center><font color="#36648B">✎✎✎✎</font><br><font color="#36648B">搭建服务提供者</font></center></h4><p><strong>1、注解</strong><br>在Application上加上<code>@EnableEurekaClient</code></p>
<p><strong>2、配置</strong><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#如有多个则以逗号隔开</span></span><br><span class="line">eureka.client.serviceUrl.defaultZone = http://localhost:1111/eureka/</span><br><span class="line">spring.application.name = hello.server</span><br></pre></td></tr></table></figure></p>
<p><strong>3、查看是否生效</strong><br>可在服务中心的<code>Instances currently registered with Eureka</code>一栏看到服务的信息。</p>
<h4 id="✎✎✎✎✎高可用注册中心"><a href="#✎✎✎✎✎高可用注册中心" class="headerlink" title="✎✎✎✎✎高可用注册中心"></a><center><font color="#36648B">✎✎✎✎✎</font><br><font color="#36648B">高可用注册中心</font></center></h4><p><strong>1、配置</strong><br>只需要理解<code>eureka.client.serviceUrl.defaultZone</code>这个参数的意义即可，它相当于把注册中心用一条线连起来。只要N个注册中心可以用一条线连起来（线路可达），那么就形成了高可用集群。当超过2个注册中心时，集群中的节点需要相互关联，否则会导致某个注册中心不可达。</p>
<blockquote>
<p>有个问题：当服务注册到注册中心后，再停掉服务，从注册中心页面并不能看出这个服务已经下线。</p>
</blockquote>
<h4 id="✎✎✎✎✎服务发现与消费"><a href="#✎✎✎✎✎服务发现与消费" class="headerlink" title="✎✎✎✎✎服务发现与消费"></a><center><font color="#36648B">✎✎✎✎✎</font><br><font color="#36648B">服务发现与消费</font></center></h4><p><strong>1、maven配置</strong><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line"><span class="code">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">    &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span></span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>2、代码</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class , args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserSerivce</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">"http://HELLO.SERVER/hello"</span>,String.class).getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是上述的<code>HELLO.SERVER</code>是服务提供者模块的<code>spring.application.name</code>属性名。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/SpringCloud微服务实战_01_基础知识/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/16/SpringCloud微服务实战_01_基础知识/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">01 | 基础知识</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-16 11:28:12" itemprop="dateCreated datePublished" datetime="2019-04-16T11:28:12+08:00">2019-04-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/SpringCloud微服务实战/" itemprop="url" rel="index"><span itemprop="name">SpringCloud微服务实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="✎基础概念"><a href="#✎基础概念" class="headerlink" title="✎基础概念"></a><center><font color="#36648B">✎</font><br><font color="#36648B">基础概念</font></center></h4><p><strong>1、服务组件化</strong><br>微服务其实就是将服务组件化的过程，那么服务组件化有什么好处呢？</p>
<ul>
<li>系统的各个服务可以独立更换升级而不影响其他单元。</li>
<li>各个服务可以根据自身的情况进行水平扩展。</li>
</ul>
<p><strong>2、微服务之间的通信</strong><br>微服务之间的通信有两种方式：</p>
<ul>
<li>基于Http的RESTful API进行通信。</li>
<li>通过轻量级消息总件（比如RabbitMQ）传递消息。</li>
</ul>
<p><strong>3、去中心化</strong><br>去中心化就是让<font color="#CD5555">每一个服务来管理其自有的数据库</font>。<br>但是去中心化也有缺点，那就是不能很好地解决<font color="#CD5555">数据一致性</font>问题。所以各服务之间应该要进行<code>无事务</code>的调用，若过程有错误，则通过补偿机制进行处理，只要求数据在<font color="#CD5555">最后的处理状态是一致</font>的即可。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/SpringCloud微服务实战_02_微服务构建/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/16/SpringCloud微服务实战_02_微服务构建/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">02 | 微服务构建</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-16 11:28:12" itemprop="dateCreated datePublished" datetime="2019-04-16T11:28:12+08:00">2019-04-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-07 16:21:41" itemprop="dateModified" datetime="2020-01-07T16:21:41+08:00">2020-01-07</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Spring/SpringCloud微服务实战/" itemprop="url" rel="index"><span itemprop="name">SpringCloud微服务实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="✎SpringBoot的Maven配置"><a href="#✎SpringBoot的Maven配置" class="headerlink" title="✎SpringBoot的Maven配置"></a><center><font color="#36648B">✎</font><br><font color="#36648B">SpringBoot的Maven配置</font></center></h4><p>构建SpringBoot工程，只需要引入<code>spring-boot-starter-parent</code>与若干<code>Starter POM</code>，并且只需要指定<code>spring-boot-starter-parent</code>的版本，而不需要指定<code>Starter POM</code>的版本。因为<code>spring-boot-starter-parent</code>已经定义了<font color="#CD5555"><strong>Spring Boot版本的基础依赖</strong></font>以及一些<font color="#CD5555"><strong>默认配置</strong></font>内容（如配置文件application.properties的位置等）。<br><code>Starter POM</code>采用<strong>spring-boot-starter-*</strong>的命名方式。</p>
<h4 id="✎✎用MockMvc进行单元测试"><a href="#✎✎用MockMvc进行单元测试" class="headerlink" title="✎✎用MockMvc进行单元测试"></a><center><font color="#36648B">✎✎</font><br><font color="#36648B">用MockMvc进行单元测试</font></center></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringJUnitWebConfig</span>(classes = Application.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span></span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.standaloneSetup(<span class="keyword">new</span> HelloController()).build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.get(<span class="string">"/hello"</span>).accept(MediaType.APPLICATION_JSON))</span><br><span class="line">        .andExpect(status().isOk()).andExpect(content().string((<span class="string">"Hello World"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="✎✎✎配置文件详解"><a href="#✎✎✎配置文件详解" class="headerlink" title="✎✎✎配置文件详解"></a><center><font color="#36648B">✎✎✎</font><br><font color="#36648B">配置文件详解</font></center></h4><p><strong>1、配置文件</strong><br>SpringBoot的默认配置文件路径：<code>src/main/resources/application.properties</code></p>
<p><strong>2、YAML配置文件</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">environments:</span><br><span class="line">    dev:</span><br><span class="line">        url : http://dev.bar.com</span><br><span class="line">        name : Developer Setup</span><br><span class="line">    prod:</span><br><span class="line">        url : http://foo.bar.com</span><br><span class="line">        name : My Cool App</span><br></pre></td></tr></table></figure></p>
<p>YAML配置文件有以下<font color="#CD5555"><strong>优缺点</strong></font>：</p>
<ul>
<li>优点：将属性加载到内存中保存的时候是<code>有序</code>的。</li>
<li>缺点：无法通过<code>@PropertySource</code>注解来加载配置。</li>
</ul>
<h4 id="✎✎✎✎属性详解"><a href="#✎✎✎✎属性详解" class="headerlink" title="✎✎✎✎属性详解"></a><center><font color="#36648B">✎✎✎✎</font><br><font color="#36648B">属性详解</font></center></h4><p><strong>1、属性说明</strong><br>指定端口：<code>server.port</code><br>指定应用名：<code>spring.application.name</code><br>定义多个不同的环境配置：<code>spring.profiles.active</code></p>
<p><strong>2、用<code>@Value</code>加载属性</strong><br><code>@Value</code>的两种加载配置方式</p>
<ul>
<li>PlaceHolder方式：<code>${...}</code></li>
<li>SpEL表达式：<code>#{...}</code></li>
</ul>
<p><strong>3、参数引用</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book.name = SpringCloud</span><br><span class="line">book.author = hjl</span><br><span class="line">book.desc = $&#123;book.author&#125; is writing《$&#123;book.name&#125;》</span><br></pre></td></tr></table></figure></p>
<p><strong>4、用<code>${random}</code>设置随机数</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#随机字符串</span><br><span class="line">com.didispace.blog.value=$&#123;random.value&#125;</span><br><span class="line">#随机int</span><br><span class="line">com.didispace.blog.value=$&#123;random.int&#125;</span><br><span class="line">#随机long</span><br><span class="line">com.didispace.blog.value=$&#123;random.long&#125;</span><br><span class="line">#10以内的随机数</span><br><span class="line">com.didispace.blog.value=$&#123;random.int(10)&#125;</span><br><span class="line">#10~20的随机数</span><br><span class="line">com.didispace.blog.value=$&#123;random.int[10,20]&#125;</span><br></pre></td></tr></table></figure></p>
<p>可使用随机数生成随机端口避免端口冲突。</p>
<p><strong>5、使用命令行参数指定属性</strong><br><code>java -jar xxx.jar --server.port=8888</code></p>
<h4 id="✎✎✎✎✎多环境配置"><a href="#✎✎✎✎✎多环境配置" class="headerlink" title="✎✎✎✎✎多环境配置"></a><center><font color="#36648B">✎✎✎✎✎</font><br><font color="#36648B">多环境配置</font></center></h4><p>多环境配置的文件名需要满足<code>application-{profile}.properties</code>的格式。可以通过<code>spring.profiles.active</code>参数指定不同的配置文件。若不指定，则默认的profile是<font color="#CD5555"><strong>dev</strong></font>。</p>
<p><strong>多环境配置思路</strong></p>
<ul>
<li>将<font color="#CD5555"><strong>通用的配置</strong></font>内容放到<code>application.properties</code>。</li>
<li>将<font color="#CD5555"><strong>特定的内容</strong></font>放到<code>application-{profile}.properties</code>。</li>
<li>通过<code>spring.profiles.active</code>加载不同环境的配置文件。</li>
</ul>
<h4 id="✎✎✎✎✎✎配置文件加载顺序"><a href="#✎✎✎✎✎✎配置文件加载顺序" class="headerlink" title="✎✎✎✎✎✎配置文件加载顺序"></a><center><font color="#36648B">✎✎✎✎✎✎</font><br><font color="#36648B">配置文件加载顺序</font></center></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">命令行参数</span><br><span class="line">SPRING_APPLICATION_JSON中的属性</span><br><span class="line">来自java:comp/env的JNDI属性</span><br><span class="line">Java系统属性（System.getProperties()）</span><br><span class="line">操作系统环境变量</span><br><span class="line">RandomValuePropertySource配置的random.*属性值</span><br><span class="line">jar包外部的application-&#123;profile&#125;.properties或application.yml（带spring.profile）配置文件</span><br><span class="line">jar包内部的application-&#123;profile&#125;.properties或application.ym（带spring.profile）配置文件</span><br><span class="line">jar包外部的application.properties或application.yml（不带spring.profile）配置文件</span><br><span class="line">jar包内部的application.properties或application.yml（不带spring.profile）配置文件</span><br><span class="line">@Configuration注解类上的@PropertySource</span><br><span class="line">通过SpringApplication.setDefaultProperties指定的默认属性</span><br></pre></td></tr></table></figure>
<h4 id="✎✎✎✎✎✎✎监控与管理"><a href="#✎✎✎✎✎✎✎监控与管理" class="headerlink" title="✎✎✎✎✎✎✎监控与管理"></a><center><font color="#36648B">✎✎✎✎✎✎✎</font><br><font color="#36648B">监控与管理</font></center></h4><p>首先需要引入引入<font color="#CD5555"><strong>actuator</strong></font>的starter pom。<br>默认情况下，只有<code>/health</code>和<code>/info</code>这两个端点通过http暴露了出来。所以当我们在访问<code>http://localhost:8080/actuator</code>这个接口时，会得到如下json：</p>
<p><img src="/2019/04/16/SpringCloud微服务实战_02_微服务构建/default.png" alt=""></p>
<p>以下是Spring官网给出的所有端点描述：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html" title="[spring_url]:" target="_blank" rel="noopener"><font color="#36648B"><strong>spring官网关于Endpoints的资料</strong></font></a></p>
<p><img src="/2019/04/16/SpringCloud微服务实战_02_微服务构建/list.png" alt=""></p>
<p>可以通过这个设置<code>management.endpoints.web.exposure.include = *</code>，将其他端口也通过http暴露出来。<br><code>/shutdown</code>这个端点默认是不开启的，还需要再加上配置<code>management.endpoint.shutdown.enabled=true</code>开启这个端点。<br>当我们访问<code>/health</code>这个端点的时候，加上<code>management.endpoint.health.show-details=always</code>会将更详细的检验器信息打印出来。Spring内置了许多校验器，具体的可以去<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html" title="[spring_url]:" target="_blank" rel="noopener"><font color="#36648B"><strong>spring官网</strong></font></a>查一下。我们也可以实现自己的校验器，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServiceHealthIndicator</span> <span class="keyword">implements</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">health</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="comment">//模拟校验成功</span></span><br><span class="line">            <span class="keyword">return</span> Health.up().build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//模拟校验失败</span></span><br><span class="line">        <span class="keyword">return</span> Health.down().withDetail(<span class="string">"status"</span> , <span class="string">"500"</span>).withDetail(<span class="string">"message"</span> , <span class="string">"服务器错误"</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/15/Java并发编程实战_05_构建块/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/15/Java并发编程实战_05_构建块/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">05 | 构建块</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-15 19:26:35" itemprop="dateCreated datePublished" datetime="2019-04-15T19:26:35+08:00">2019-04-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-03-16 20:32:21" itemprop="dateModified" datetime="2020-03-16T20:32:21+08:00">2020-03-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Java并发编程实战/" itemprop="url" rel="index"><span itemprop="name">Java并发编程实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <center> <h4><font color="#36648B">✎<br>在并发中迭代</font></h4></center><br><code>Iterator</code>与<code>for-each</code>在循环的过程中，会监听一个计数器，如果计数器被修改（集合被修改），则会抛出<code>ConcurrentModificationException</code>。<br>值得一提的是修改计数器并不是一个线程安全的操作，所以有可能线程A在迭代，线程B修改了集合，但是线程A没抛出<code>ConcurrentModificationException</code>。<br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiddenIterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Integer&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Integer i)</span></span>&#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Integer i)</span></span>&#123;</span><br><span class="line">        set.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addThenThings</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            add(random.nextInt());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br>上面的代码中，由于迭代（println会打印toString的内容，而hashSet的toString方法就是使用Iterator拼接Set的所有元素）与容器内元素的改变（HiddenIterator#get/set）没有使用同一个锁，所以在迭代时候有可能会出现ConcurrentModificationException。<br>解决的方法很简单，保持这两者的锁一致即可。<br><br><center> <h4><font color="#36648B">✎✎<br>常用的并发类</font></h4></center>

<p><strong>1、Map</strong></p>
<ul>
<li><strong>ConcurrentHashMap</strong>：非独占锁，在并发情况下用来代替<code>HashMap</code>。提供不抛出ConcurrentModificationException的迭代器，这个迭代器拥有“弱一致性”而不是“及时失败”，允许并发修改。它的<code>size()</code>方法与<code>empty()</code>方法是估算值，并不完全准确。<blockquote>
<p>这个迭代器是怎么实现的？</p>
</blockquote>
</li>
<li><strong>ConcurrentSkipListMap</strong>：在并发情况下用来代替<code>SortedMap</code>。<blockquote>
<p>SortedMap是什么形式的Map？</p>
</blockquote>
</li>
<li><strong>Hashtable</strong>：独占锁。</li>
<li><strong>Collections.synchronizedMap</strong>：独占锁。</li>
</ul>
<p><strong>2、List</strong></p>
<ul>
<li><strong>CopyOnWriteList</strong>：在并发情况下用来代替List。<br>容器的迭代器保留一个底层基础数组，这个数组的元素永远不会被修改，所以在迭代进行读取时，不需要加锁。迭代时，也不会抛出<code>ConcurrentModificationException</code>。<br>当需要修改元素时，会复制一个数组并对这个数组进行修改，然后直接替换基础数组。</li>
</ul>
<p><strong>3、Set</strong></p>
<ul>
<li><strong>ConcurrentSkipListSet</strong>：在并发情况下用来代替SortedSet。</li>
<li><strong>CopyOnWriteArraySet</strong>：在并发情况下用来代替Set。</li>
</ul>
<center> <h4><font color="#36648B">✎✎✎<br>Queue</font></h4></center>

<p><strong>1、Queue的框架图</strong></p>
<p><img src="/2019/04/15/Java并发编程实战_05_构建块/Queue框架图.png" alt=""></p>
<p>实现了BlockingQueue的都是阻塞队列（支持并发）。阻塞队列需要<code>catch InterruptionException</code>。<br>带有Priority的都是优先级队列。<br><code>ConcurrentLinkedQueue</code>、<code>LinkedBlockingQueue</code>、<code>ArrayListBlockingQueue</code>是<strong>FIFO队列</strong>。</p>
<p><strong>2、BlockingQueue</strong><br>可以是有界的也可以是无界的。<br>非定时阻塞的方法：<code>put</code>、<code>take</code>。<br>可定时阻塞的方法：<code>offer</code>、<code>poll</code>。</p>
<p><strong>3、SynchronousQueue</strong><br>SynchronousQueue没有存储功能，因此put和take会一直阻塞，直到有另一个线程已经准备好参与到交付过程中。仅当有足够多的消费者，并且总是有一个消费者准备好获取交付的工作时，才适合使用同步队列。</p>
<p>生产者-消费者模式中，如果一个是I/O密集型，另一个是CPU密集型，那么并发执行的吞吐率要高于串行执行的吞吐率。如果生产者和消费者的并行度不同，那么将它们紧密耦合在一起会把整体并行度降低为二者中更小的并行度。</p>
<p><strong>4、用双端队列实现工作密取。</strong><br>如果一个消费者完成了自己双端队列中的全部工作，那么它可以从其他消费者双端队列末尾秘密地获取工作。</p>
<center> <h4><font color="#36648B">✎✎✎✎<br>中断</font></h4></center>

<p>中断并不是强制另外一个线程立刻停下来，只能要求另外一个线程在可以暂停的地方停止正在执行的工作。（当然被中断的线程也可以恢复中断，继续执行）</p>
<blockquote>
<p>其实就是try catch Interruption的应用。</p>
</blockquote>
<center> <h4><font color="#36648B">✎✎✎✎✎<br>缓存方案</font></h4></center>

<p>在做缓存时，计算value可能会需要很长的时间。通常的逻辑是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    同步块保护&#123;</span><br><span class="line">        <span class="comment">//根据key get value</span></span><br><span class="line">       <span class="keyword">if</span>(value 不存在)&#123;</span><br><span class="line">          <span class="comment">//根据key 计算value，</span></span><br><span class="line">          <span class="comment">//push 进map</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回value </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>当然，还可能再优化成分段锁(根据key分段)，或者优化成DCL双锁去保护value的计算，避免在读已存在缓存时进入同步块。<br>但是终究会有弊端：</p>
<ul>
<li>同步开销大。</li>
<li>不同的key可能会使用同一个锁。（不可能为每一个key都生成一个锁，一般都会采用对key进行hash后取得相应的锁这种策略）</li>
</ul>
</blockquote>
<p>可用futureTask来代替上述逻辑，将计算放到一个线程任务中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getValue</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">    <span class="comment">/**新建计算value的futureTask A**/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果map已存在此future，则返回此future，此时抛弃futureTask A。否则将futureTask A push进去</span></span><br><span class="line">    currentFutureTask = map.putIfAbsent(key , future);</span><br><span class="line">    <span class="keyword">if</span>(currentFutureTask == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//如果purIfAbsent为null，则表示push进去的是futureTask A，需要submit futureTask A进行计算</span></span><br><span class="line">        <span class="comment">/**submit future任务**/</span></span><br><span class="line">        <span class="comment">/**currentFutureTask = futureTask A**/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentFutureTask.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用这种方式可以避免上述过程中所论述的弊端。</p>
<blockquote>
<p>需要整理一下，JDK提供的各种线程安全类。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/03/Java并发编程实战_04_组合对象/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/03/Java并发编程实战_04_组合对象/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">04 | 组合对象</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-03 17:49:12" itemprop="dateCreated datePublished" datetime="2019-04-03T17:49:12+08:00">2019-04-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-13 13:04:22" itemprop="dateModified" datetime="2020-01-13T13:04:22+08:00">2020-01-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Java并发编程实战/" itemprop="url" rel="index"><span itemprop="name">Java并发编程实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <center> <h4><font color="#36648B">✎<br>私有锁与对象锁</font></h4></center>

<p><em><font color="#36648B">对象锁会暴露给外部，而私有锁不会。</font></em></p>
<p><strong>对Collections.unmodifiableMap的一些探讨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test7</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;Integer , Location&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="number">1</span> , <span class="keyword">new</span> Location(<span class="number">1</span> ,<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        Map&lt;Integer , Location&gt; otherMap = Collections.unmodifiableMap(map);</span><br><span class="line">        System.out.println(<span class="string">"map "</span>+map.get(<span class="number">1</span>));   <span class="comment">//输出 map 1,1</span></span><br><span class="line">        System.out.println(<span class="string">"othermap "</span>+otherMap.get(<span class="number">1</span>)); <span class="comment">//输出 othermap 1,1</span></span><br><span class="line"></span><br><span class="line">        map.get(<span class="number">1</span>).setX(<span class="number">11</span>);</span><br><span class="line">        System.out.println(<span class="string">"othermap "</span>+otherMap.get(<span class="number">1</span>)); <span class="comment">//输出 othermap 11,1</span></span><br><span class="line"></span><br><span class="line">        otherMap.get(<span class="number">1</span>).setX(<span class="number">12</span>);</span><br><span class="line">        System.out.println(<span class="string">"othermap "</span>+otherMap.get(<span class="number">1</span>)); <span class="comment">//输出 othermap 12,1</span></span><br><span class="line"></span><br><span class="line">        otherMap.put(<span class="number">2</span> , <span class="keyword">new</span> Location(<span class="number">1</span> ,<span class="number">1</span>)); <span class="comment">//抛出java.lang.UnsupportedOperationException</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Location</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Location</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.x = x;</span><br><span class="line">            <span class="keyword">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x+<span class="string">","</span>+y;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//getter and setter ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面的输出可知，unmodifiableMap的value执行的是<code>深层复制</code>，而且<u><em>可以对value对象里面的属性进行更改。但是不能对引用进行更改</em></u>。</p>
<p>任何的线程问题都可以从这个角度出发：<font color="red"><strong>内存是否一致</strong></font>。</p>
<center> <h4><font color="#36648B">✎✎<br>由于锁不一样导致的问题</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListHelper</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">putIfAbsent</span><span class="params">(E x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> absent = !list.contains(x);</span><br><span class="line">        <span class="keyword">if</span>(absent)&#123;</span><br><span class="line">            list.add(x);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> absent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>synchronizedList这个方法提供了同步的方法，但是锁的对象是内置的一个obejct。<br>由于以下两点原因：</p>
<ul>
<li>list的get/set的锁与putIfAbsent的锁不是同一个锁。</li>
<li>list是由public修饰的，所以可以直接被访问。</li>
</ul>
<p>导致putIfAbsent其实是线程不安全的。</p>
<p>解决这个问题也很简单：<br>将list修改为private修饰，不让外界访问它的get/set方法，或者将它的get/set用ListHelper这个对象锁保护，保证与putIfAbsent使用的是同一个锁。（当然，这样就没必要用synchronizedList了）<br>以下Demo中，让putIfAbsent使用synchronizedList所使用的锁，（本质上也是保持使用锁的一致）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListHelper</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;E&gt; list = Collections.synchronizedList(<span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putIfAbsent</span><span class="params">(E x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list)&#123;</span><br><span class="line">            <span class="keyword">boolean</span> absent = !list.contains(x);</span><br><span class="line">            <span class="keyword">if</span>(absent)&#123;</span><br><span class="line">                list.add(x);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> absent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>synchronizedList的构造方法中，如果没有传锁对象，则会把本对象(list)，作为锁对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SynchronizedCollection(Collection&lt;E&gt; c) &#123;</span><br><span class="line">    <span class="keyword">this</span>.c = Objects.requireNonNull(c);</span><br><span class="line">    mutex = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SynchronizedCollection(Collection&lt;E&gt; c, Object mutex) &#123;</span><br><span class="line">    <span class="keyword">this</span>.c = Objects.requireNonNull(c);</span><br><span class="line">    <span class="keyword">this</span>.mutex = Objects.requireNonNull(mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>是否会存在这种情况：对象创建时引用已经赋值给变量了，但是对象方法还未被初始化？<br>答：如果不是final类型或volatile类型的对象初始化，确实会有这样的情况。</p>
</blockquote>
<blockquote>
<p>ListHelper应该也是会有线程安全问题？</p>
</blockquote>
<p>使用<code>装饰器方法</code>保护非线程安全的类：</p>
<blockquote>
<p>e.g 使用<strong>Collections.synchronizedList</strong>保护ArrayList。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/22/Java并发编程实战_02_线程安全性/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/22/Java并发编程实战_02_线程安全性/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">02 | 线程安全性</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-22 10:49:43" itemprop="dateCreated datePublished" datetime="2019-03-22T10:49:43+08:00">2019-03-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-13 12:37:35" itemprop="dateModified" datetime="2020-01-13T12:37:35+08:00">2020-01-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Java并发编程实战/" itemprop="url" rel="index"><span itemprop="name">Java并发编程实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>1、什么时候需要同步？</strong></p>
<p>该变量是<font color="red">共享</font>且<font color="red">可变</font>的。</p>
<p><strong>2、实现同步的4种方法</strong></p>
<ul>
<li>volatile</li>
<li>synchronized</li>
<li>显示锁Lock</li>
<li>原子类Atomic</li>
</ul>
<p><strong>3、不变性的定义</strong></p>
<p>无论在单线程还是多线程，结果永远不变。</p>
<p><strong>4、其他知识点</strong></p>
<p>Servlet是<font color="red">单例</font>的，如果在某个Servlet类添加可变的局部变量，则要考虑此变量是否需要同步访问。</p>
<p>加锁与解锁都需要消耗资源，对于同一块代码，应该尽可能地少用同步块（能用一个同步块解决的，就不要用两个同步块）。</p>
<p>可以用FindBugs插件检查代码是否会有bug。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/22/Java并发编程实战_03_对象的共享/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="aFightz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aFightz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/22/Java并发编程实战_03_对象的共享/" class="post-title-link" itemprop="http://yoursite.com/page/8/index.html">03 | 对象的共享</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-22 10:49:43" itemprop="dateCreated datePublished" datetime="2019-03-22T10:49:43+08:00">2019-03-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-21 11:15:53" itemprop="dateModified" datetime="2020-01-21T11:15:53+08:00">2020-01-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/学习笔记/Java/Java并发编程实战/" itemprop="url" rel="index"><span itemprop="name">Java并发编程实战</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <center> <h4><font color="#36648B">✎<br>未同步的情况下使用共享变量带来的问题</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoVisibility</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> ready;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!ready)&#123;</span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ReaderThread().start();</span><br><span class="line">        value = <span class="number">10</span>;</span><br><span class="line">        ready = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能会有三种情况出现</p>
<ul>
<li>程序正常结束，输出10</li>
<li>程序正常结束，输出0</li>
<li>正确无法结束，一直在无限循环。</li>
</ul>
<blockquote>
<p>涉及到的知识点:</p>
<ul>
<li>volatile与Java线程模型</li>
<li>重排序的概念</li>
<li>多线程的环境下重排序导致的问题(可以将两个线程变成一个流程，串行去理解)</li>
<li>volatile防止重排序</li>
</ul>
</blockquote>
<center> <h4><font color="#36648B">✎✎<br>volatile与synchronized</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Score</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> value;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//强制从主存拿value</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//强制把value刷到主存</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Score</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的两种方式的效果大体相同，但是前者可见性更强（16章会讲）。</p>
<p>volatile不会执行加锁操作，所以开销会比synchronized更小。</p>
<center> <h4><font color="#36648B">✎✎<br>内部类导致的线程不安全（this引用逸出）</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThisEscape</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThisEscape</span><span class="params">(EventSource source)</span></span>&#123;</span><br><span class="line">        source.registerListener(</span><br><span class="line">            <span class="keyword">new</span> EventListener()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span></span>&#123;</span><br><span class="line">                    <span class="comment">//doSomething属于ThisEscape</span></span><br><span class="line">                    doSomething(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述例子中，ThisEscape有可能还没被创建完成，doSomething方法就被调用了。<br>可以使用工厂方法避免这种的错误，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeListener</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventListener listener;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafeListener</span><span class="params">()</span></span>&#123;</span><br><span class="line">        listener = <span class="keyword">new</span> EventListener()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span></span>&#123;</span><br><span class="line">                <span class="comment">//doSomething属于ThisEscape</span></span><br><span class="line">                doSomething(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafeListener <span class="title">newInstance</span><span class="params">(EventSource source)</span></span>&#123;</span><br><span class="line">        SafeListener safe = <span class="keyword">new</span> SafeListener();</span><br><span class="line">        source.registerListener(safe.listener);</span><br><span class="line">        <span class="keyword">return</span> safe; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总的思路就是，在构造完对象之前,不能让this逸出。</p>
<blockquote>
<p>如果listener对象不是final类型或者volatile类型的，也是属于不安全发布的。</p>
</blockquote>
<center> <h4><font color="#36648B">✎✎✎<br>使用ThreadLocal保证线程安全</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; value = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">getValue</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadLocal内部用Map结构保存了当前线程（Thread.currentThread()）对应的值。所以每一个线程都有属于自己的value。<br>ThreadLocal变量类似于全局变量，它能降低代码的可重用性。例如将某个全局变量作为ThreadLocal对象。</p>
<center> <h4><font color="#36648B">✎✎✎✎<br>final</font></h4></center>

<p>final能保证初始化过程中的安全性（如果this引用逸出还能保证安全性吗）。<br>volatile不仅能保证初始化过程中的安全性，还能保证可见性。</p>
<p><strong>final的重排序规则</strong></p>
<ul>
<li>在构造函数内对一个final域的写入，与随后把这个被构造对象的引用赋值给一个引用变量，这两个操作之间不能重排序。</li>
<li>初次读一个包含final域的对象的引用，与随后初次读这个final域，这两个操作之间不能重排序。</li>
</ul>
<blockquote>
<font color="#7EC0EE">总的来说就是final在写之前不会被读。</font>
</blockquote>
<center> <h4><font color="#36648B">✎✎✎✎✎<br>对“使用不可变类来实现线程安全”的分析</font></h4></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer[] factors;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cache</span><span class="params">(Integer value , Integer[] factors)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.factors = factors;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Integer[] getFactors() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.copyOf(factors , factors.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheUtil</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Cache cache = <span class="keyword">new</span> Cache(<span class="keyword">null</span> , <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer[] getFactors(Integer i)&#123;</span><br><span class="line">        Integer[] factors = cache.getFactors(i);</span><br><span class="line">        <span class="keyword">if</span>(factors == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//因式分解得到factors</span></span><br><span class="line">            </span><br><span class="line">            cache = <span class="keyword">new</span> Cache(i , factors);<span class="comment">//volatile类型的初始化是线程安全的    </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> factors;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个Demo里，线程安全是指Cache类里的value变量与factors变量要保持同步一致，也就是说这两者要能同步初始化，同步更新。由于没有使用DCL，所以可能会出现初始化两次的情况，但是这没关系，因为逻辑就是只保存最新的因式分解结果。<br>CacheUtil的cache变量使用了volatile。volatile保证cache不会失效，以及保证cache的初始化是线程安全的。</p>
<center> <h4><font color="#36648B">✎✎✎✎✎<br>安全发布一个对象的四种模式</font></h4></center>

<ul>
<li>在静态初始化函数中初始化一个对象引用。</li>
<li>将对象的引用保存到volatile或AtomicReferance对象中。</li>
<li>用final修饰对象的引用。</li>
<li>将对象的引用保存到一个由锁保护的域中。<blockquote>
<p>即使this引用逸出，volatile、Atomic、final也会是线程安全的吗？答：逸出绝对是线程不安全的。<br>线程安全的容器类也属于锁保护的域。<br>在构造函数内对一个变量（属于上面4种模式模之一）的写入，与随后把这个被构造对象的引用赋值给一个引用变量，这两个操作之间不能重排序。</p>
</blockquote>
</li>
</ul>
<h4 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a>疑惑</h4><ul>
<li>NoVisibilityDemo实际运行的时候，如果加上Thread.yield()，其他线程ready会拿到最新值，而如果去掉Thread.yield()让while无限循环，那么ready则不会取到最新值，这是为什么？</li>
<li>volatile类型能保证long、double的get/set是原子的吗？</li>
<li>禁止volatile的重排序意义是什么？因为其他类型应该都不是共享的。</li>
</ul>
<p><center> <h4><font color="#36648B">✎✎✎✎✎✎<br>锁</font></h4></center><br>假设有锁M，那么在M上调用unlock之前的所有操作结果，对于在M上调用lock之后的线程都是可见的。</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">aFightz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">98</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aFightz</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  





  

  

  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  


  
  

  

  

  

  

  

  

</body>
</html>

---
title: 06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？ 
date: 2019-01-09 14:43:43
tags: [MySQL]
categories :
- 学习笔记
- MySQL
- MySQL实战45讲
---

### Mysql锁类型
- 全局锁
- 表级锁
- 行锁

### 全局锁
- 加全局表锁（让整个数据库处于只读状态）的方法：
  `Flush tables with read lock (FTWRL)`，其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。
  使用场景：做全库备份时。

- 其他的设置只读的方法：
 - 利用mysqldump工具的`-single-transaction`参数。导数据之前就会开启一个事务，确保拿到一个一致性视图（类似RR隔离级别的实现原理）。缺点就是有些引擎是不支持事务的。
 - `set global readonly = true`。这样也可以让全库进入只读状态，但是有如下缺点：
   - 有些系统中，readonly会被用来作其他逻辑。比如判断一个库是主库还是从库。
   - 如果在执行FTWRL时，客户端发生异常，锁会被释放。但set global readonly = true是不会释放锁的。


### 表级锁
#### 表级锁的类型
- 表锁。
- 元数据锁（meta data lock,MDL）。


### 表锁
```sql
#锁表
lock tables ... read/write
```

```sql
#释放锁
unlock tables
```

如果一个线程对表A加了read lock，那么所有线程都只能读表A而不能写入表A。
如果一个线程对表A加了write lock，那么只能这个线程能写、读表A。其他线程对表A的写、读都会被阻塞。

### MDL

不需要显示使用，对一个表做增删改查操作时，自动加MDL读锁。对表做结构变更操作时，加MDL写锁。
读/读不互斥，读/写，写/写互斥。（也就是我们平常认知里的读写锁）











